10 CLS:DEFINT A-Z
20 PRINT "JMODEM by Joshua Foster"
30 PRINT "Opening serial port...";
40 OPEN "COM2:4800,N,8,1,CS,DS,CD" AS #1
50 PRINT "Waiting for data..."
60 'Receive header
70 FIELD 1, 1 AS SOH$, 12 AS FILENAME$, 2 AS FILESIZE$, 1 AS CHK$
80 GET 1, 16
90 FILESIZE=CVI(FILESIZE$):TOTALBYTES=0
100 OPEN FILENAME$ FOR OUTPUT AS #2
110 PRINT "Receiving "FILENAME$" ("FILESIZE" bytes)..."
120 PRINT #1,CHR$(6);
130 ' Receive packet
140 FIELD 1, 1 AS SOH$, 126 AS SBUF$, 1 AS CHK$
150 GET 1, 128
160 BYTES=FILESIZE-TOTALBYTES
170 IF BYTES > 126 THEN BYTES = 126
180 ' Copy packet data to filebuf ---
190 PRINT #2, LEFT$(SBUF$,BYTES);
200 TOTALBYTES=TOTALBYTES+BYTES
210 PRINT TOTALBYTES"...";
220 'Ack the packet and recv the next one
230 PRINT #1,CHR$(6);
240 IF TOTALBYTES<FILESIZE THEN GOTO 130
250 CLOSE
260 PRINT "Complete!"
270 END
280 ' --- Subroutines ---
290 'Checksum SBUF$. Return result in VALID.
300 SUM=0
310 FOR I=0 TO 133:SUM=SUM+SBUF(I):NEXT I
320 VALID=((SUM MOD 256)=SBUF(134))
330 RETURN